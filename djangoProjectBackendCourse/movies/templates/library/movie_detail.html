{% extends 'base.html' %}
{% load static %}
{% block title %}{{ movie.title }} - Movie Details{% endblock %}

{% block content %}
<link rel="stylesheet" type="text/css" href="{% static 'library/movie_detail.css' %}">

<div class="movie-detail-container">
    <!-- Back Button -->
    <div class="back-navigation">
        <a href="{% url 'library:all_movies' %}" class="back-btn">
            <span class="back-arrow">←</span> Back to Library
        </a>
    </div>

    <!-- Movie Details Section -->
    <div class="movie-detail-card">
        <div class="movie-poster-section">
            {% if movie.poster %}
                <img src="{{ movie.poster.url }}" alt="{{ movie.title }}" class="detail-poster">
            {% else %}
                <div class="no-poster-detail">
                    <span>No Poster Available</span>
                </div>
            {% endif %}
        </div>

        <div class="movie-info-section">
            <div class="movie-header">
                <h1 class="movie-title">{{ movie.title }}</h1>
                <div class="movie-year-badge">{{ movie.year_of_release }}</div>
            </div>

            <div class="movie-details">
                <div class="detail-item">
                    <span class="detail-label">Director:</span>
                    <span class="detail-value">{{ movie.director }}</span>
                </div>

                <div class="detail-item">
                    <span class="detail-label">Main Actors:</span>
                    <span class="detail-value">{{ movie.four_main_actors }}</span>
                </div>

                <div class="detail-item">
                    <span class="detail-label">Release Year:</span>
                    <span class="detail-value">{{ movie.year_of_release }}</span>
                </div>
            </div>

            <div class="movie-description">
                <h3>Synopsis</h3>
                <p>{{ movie.description }}</p>
            </div>

            <div class="movie-rating-summary">
                {% if movie.reviews.exists %}
                    <div class="rating-display">
                        <span class="star-large">★</span>
                        <span class="rating-value">{{ movie.average_rating|floatformat:1 }}/5</span>
                        <span class="rating-count">({{ movie.reviews.count }} review{{ movie.reviews.count|pluralize }})</span>
                    </div>
                {% else %}
                    <div class="no-ratings">
                        <span>No ratings yet - Be the first to review!</span>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Reviews Section -->
    <div class="reviews-section">
        <div class="reviews-header">
            <h2>Reviews</h2>
        </div>

        <!-- Review Form (for authenticated users) -->
        {% if user.is_authenticated %}
            <div class="review-form-container" id="reviewForm">
                <form method="post" class="review-form">
                    {% csrf_token %}
                    <h3>Write Your Review</h3>

                    <div class="form-group">
                        <label for="reviewer_name">Your Name:</label>
                        <input type="text"
                               id="reviewer_name"
                               name="reviewer_name"
                               class="form-input"
                               value="{{ user.get_full_name|default:user.username }}"
                               required>
                    </div>

                    <div class="form-group">
                        <label for="rating">Rating:</label>
                        <div class="rating-input">
                            <select id="rating" name="rating" class="rating-select" required>
                                <option value="">Select Rating</option>
                                <option value="1">★ 1 - Poor</option>
                                <option value="2">★★ 2 - Fair</option>
                                <option value="3">★★★ 3 - Good</option>
                                <option value="4">★★★★ 4 - Very Good</option>
                                <option value="5">★★★★★ 5 - Excellent</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="review_text">Your Review:</label>
                        <textarea id="review_text"
                                  name="review_text"
                                  class="form-textarea"
                                  rows="5"
                                  placeholder="Share your thoughts about this movie..."
                                  ></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="submit-review-btn">Submit Review</button>
                    </div>
                </form>
            </div>
        {% else %}
            <div class="login-prompt">
                <p>Please <a href="{% url 'users:login' %}" class="login-link">login</a> to write a review.</p>
            </div>
        {% endif %}

        <!-- Existing Reviews -->
        <div class="reviews-list">
            {% for review in movie.reviews.all %}
                <div class="review-item">
                    <div class="review-header">
                        <div class="reviewer-info">
                            <span class="reviewer-name">{{ review.reviewer_name }}</span>
                            <span class="review-date">{{ review.review_date|date:"M d, Y" }}</span>
                        </div>
                        <div class="review-rating">
                            {% for i in "12345" %}
                                {% if forloop.counter <= review.rating %}
                                    <span class="star filled">★</span>
                                {% else %}
                                    <span class="star empty">☆</span>
                                {% endif %}
                            {% endfor %}
                            <span class="rating-number">{{ review.rating }}/5</span>
                        </div>
                    </div>
                    <div class="review-content">
                        <p>{{ review.review_text }}</p>
                    </div>
                </div>
            {% empty %}
                <div class="no-reviews">
                    <p>No reviews yet. Be the first to share your thoughts!</p>
                </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}